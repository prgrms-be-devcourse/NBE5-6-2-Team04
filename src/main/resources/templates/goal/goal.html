<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>DevQuest Dashboard</title>
  <link rel="stylesheet" th:href="@{/css/dashboard.css}">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

</head>

<body>
<h1>ëª©í‘œ ê¸°ì—… ìƒì„¸ í˜ì´ì§€ì…ë‹ˆë‹¤</h1>
<p th:text="'ê¸°ì—…ëª…: ' + ${company.companyName}">ê¸°ì—…ëª… ë¡œë”© ì‹¤íŒ¨</p>

<div id="logo-container"></div>
<div class="dashboard">

  <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°” -->
  <aside class="sidebar">
    <h1 class="logo">
      <a th:href="@{/static}" style="text-decoration: none; color:inherit;">
        DevQuest
      </a>
    </h1>
    <div class="createdAt-comment">
      <span class="day-count" th:text="${dashboard.dayCount} + 'ì¼ì§¸'">N ì¼ì§¸</span>
      <span class="comment" th:text="${dashboard.comment}">ìŠ¬ë¡œê±´</span>
    </div>
    <span class="nickname" th:text="${dashboard.nickname}">íšŒì›</span>
    <span class="nickname-sir">ë‹˜</span>

    <!--  ê´€ì‹¬ë¶„ì•¼ íƒœê·¸  -->
    <div class="tags">
      <span class="tag"
            th:if="${dashboard.jobType != null and !dashboard.jobType.isEmpty()}"
            th:text="'#' + ${dashboard.jobType[0]}">#ì§ë¬´</span>
      <span class="tag"
            th:unless="${dashboard.jobType != null and !dashboard.jobType.isEmpty()}">#ì§ë¬´ ì—†ìŒ</span>

      <span class="tag" th:each="lang : ${dashboard.devLang}" th:text="'#' + ${lang}">#ì–¸ì–´</span>
      <span class="tag" th:each="fw : ${dashboard.framework}" th:text="'#' + ${fw}">#í”„ë ˆì„ì›Œí¬</span>
    </div>

    <!--  ë§ˆì´í˜ì´ì§€  -->
    <p class="mypage">
      <a th:href="@{/templates/mypage}" style="text-decoration: none; color: inherit;">
        <span class="material-icons">account_circle</span>ë§ˆì´í˜ì´ì§€
      </a>
    </p>

    <!-- í”„ë¡œí•„ ì¹´ë“œ -->
    <div class="profile-card">
      <div class="profile-card">
        <div class="profile-info">
          <img class="profile-img"
               th:src="${dashboard.userImage != null && !dashboard.userImage.isEmpty()
             ? '/images/profile/' + dashboard.userImage
             : '/images/profile/default.png'}"
               alt="í”„ë¡œí•„ ì´ë¯¸ì§€"/>

          <div class="level-info">
            <p class="level-label" th:text="${dashboard.levelName}">ë ˆë²¨ëª…</p>
            <p class="level-value" th:text="'Lv.' + ${dashboard.levelValue}">Lv.N</p>
          </div>
        </div>

        <!--  xp ì§„í–‰ë°”  -->
        <div class="xp-label" th:text="${dashboard.exp} + 'xp'">N xp</div>
        <div class="xp-bar">
          <div class="xp-progress"
               th:style="'width:' + (${dashboard.exp} > 100 ? 100 : dashboard.exp) + '%'">
            <span th:text="${dashboard.exp} + 'xp'"></span>
          </div>
        </div>
      </div>
    </div>

      ì•Œë¦¼ í† ê¸€
    <div class="toggle-box">
      <form th:action="@{/dashboard/notification-toggle}" method="post">
        <!-- ì„œí˜„ë‹˜ csrf í† í° ì¶”ê°€ í›„ ì£¼ì„í•´ì œ -->
        <!-- <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>-->
        <input type="checkbox"
               name="notification"
               th:checked="${dashboard.notificationOn}" onchange="this.form.submit()">
        <label>ì•Œë¦¼</label>
      </form>
    </div>

      ì£¼ìš”ì•Œë¦¼
    <div class="alert-box">
      <h3>
        ğŸ”” ì£¼ìš” ì•Œë¦¼
        <span class="count" th:text="${#lists.size(dashboard.goalCompanies)}">0</span>
      </h3>
      <ul th:if="${dashboard.notificationOn}">
        <li th:each="company : ${dashboard.goalCompanies}">
          <strong style="color:red" th:text="${company.companyName}">ê¸°ì—…ëª…</strong>
          <span th:text="${company.statusLabel != null ? company.statusLabel : 'ìƒíƒœì—†ìŒ'}">ìƒíƒœ</span>
          <span th:text="'D-' + ${company.DDay} + 'ì¼'">Nì¼</span>ì „ ì…ë‹ˆë‹¤.
        </li>
      </ul>
      <p th:unless="${dashboard.notificationOn}">
        í˜„ì¬ ì•Œë¦¼ì´ êº¼ì ¸ ìˆì–´ìš” ğŸ”•
      </p>
    </div>
  </aside>

  <!-- ë©”ì¸ ì˜ì—­ -->
  <main class="main-content">
    <div class="logout">
      <a th:href="@{/logout}" style="text-decoration: none; color: inherit;">
        ë¡œê·¸ì•„ì›ƒ
      </a>
    </div>

    <!--  Goal List   -->
    <p class="section-title" th:text="${company.companyName}">Goal List</p>

    <div class="company-list">
      <a th:each="goal : ${goals}" class="company-card">


        <div class="card-header">
          <span class="status" th:text="${goal.isDone}? 'ì™„ë£Œ' : 'ì§„í–‰ ì¤‘'">ì§„í–‰ ìƒíƒœ</span>
          <p class="company-name" th:text="${goal.title}">íšŒì‚¬ëª…</p>


          <!-- ìˆ˜ì •/ì‚­ì œ ë“œë¡­ë‹¤ìš´  -->
          <div class="dropdown">
            <button class="dropdown-toggle" type="button">â‹®</button>
            <ul class="dropdown-menu">
              <li>ìˆ˜ì •</li>
              <li>ì‚­ì œ</li>
            </ul>
          </div>
        </div>

        <!-- ëª©í‘œ ì¹´ë“œ -->
        <div class="status-dday">
          <ul>
            <li th:each="todo : ${todoMap[goal.goalId]}">
              <span th:text="${todo.content}">íˆ¬ë‘ ë‚´ìš©</span>
              <span th:if="${todo.isDone}" style="color: green;">(ì™„ë£Œ)</span>
              <span th:unless="${todo.isDone}" style="color: red;">(ë¯¸ì™„ë£Œ)</span>
            </li>
          </ul>

        </div>
      </a>

      <!-- ëª©í‘œ ìƒì„± ì¹´ë“œ -->
      <div class="company-card create" onclick="openModal('companyModal')">
        <p class="goal-todo-desc-top">
          <span class="material-icons">control_point</span>
          ëª©í‘œ ìƒì„±
        </p>

        <p class="goal-todo-desc-bottom">
          ëª©í‘œëŠ” 3ê°œê¹Œì§€ ë¬´ë£Œë¡œ ìƒì„±ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤(4ê°œ ë¶€í„° ìœ ë£Œ^^)
        </p>
      </a>
      </div>
  </main>
</div>

<!-- ëª©í‘œ ê¸°ì—… ìƒì„± ëª¨ë‹¬ -->
<div id="companyModal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close" onclick="closeModal('companyModal')">&times;</span>
    <h2>ëª©í‘œ ìƒì„±</h2>
    <form id="create-form">
      <input type="text" name="title" placeholder="ëª©í‘œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" required><br><br>

      <label>ì‹œì‘ì¼</label><br>
      <input type="date" name="startDate"><br><br>
      <label>ë§ˆê°ì¼</label><br>
      <input type="date" name="endDate"><br><br>

      <button type="submit">ìƒì„±</button>
    </form>
  </div>
</div>

<!-- ëª©í‘œ ê¸°ì—… ìƒì„± ëª¨ë‹¬ -->
<script>
  function openModal(companyModal) {
    document.getElementById(companyModal).style.display = "flex";
  }

  function closeModal(companyModal) {
    document.getElementById(companyModal).style.display = "none";
  }

</script>

<!--ëª©í‘œ ìƒì„± ëª¨ë‹¬(post ë³´ë‚´ê¸°)-->
<script th:inline="javascript">
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("create-form");

    form.addEventListener("submit", function (e) {
      e.preventDefault();

      let companyId = [[${company.companyId}]]; // ??? todo ì™œì´ëŸ¬ëŠ”ê±´ì§€...?????
      const data = {
        companyId: companyId,
        title: form.title.value,
        startDate: form.startDate.value,
        endDate: form.endDate.value
      };
      fetch(`/companies/${companyId}/goals`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
              .then(res => {
                if (res.ok) {
                  alert("ë“±ë¡ ì™„ë£Œ!");
                  closeModal('companyModal');
                  window.location.reload();
                } else {
                  alert("ë“±ë¡ ì‹¤íŒ¨");
                }
              })
              .catch(err => {
                console.error(err);
                alert("ì—ëŸ¬ ë°œìƒ");
              });
    });
  });

  function closeModal(id) {
    document.getElementById(id).style.display = 'none';
  }
</script>

<script>
  // ì™¼ìª½ ìƒë‹¨ ë¡œê³ 
  // fetch('/css/logo.html')
  // .then(res => res.text())
  // .then(html => {
  //   document.getElementById('logo-container').innerHTML = html;
  // });

  // ë“œë¡­ë‹¤ìš´(ìˆ˜ì •, ì‚­ì œ)
  document.addEventListener('DOMContentLoaded', () => {
    const toggles = document.querySelectorAll('.dropdown-toggle');

    toggles.forEach((toggle) => {
      toggle.addEventListener('click', (e) => {
        e.stopPropagation(); // ë‹¤ë¥¸ ê³³ í´ë¦­ ë§‰ê¸°
        // ëª¨ë“  ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
          if (menu !== toggle.nextElementSibling) {
            menu.style.display = 'none';
          }
        });
        // í˜„ì¬ ê²ƒë§Œ í† ê¸€
        const menu = toggle.nextElementSibling;
        menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
      });
    });

    // í˜ì´ì§€ ì–´ë””ë“  í´ë¦­í•˜ë©´ ë©”ë‰´ ë‹«í˜
    document.addEventListener('click', () => {
      document.querySelectorAll('.dropdown-menu').forEach(menu => {
        menu.style.display = 'none';
      });
    });
  });
</script>




</body>
</html>