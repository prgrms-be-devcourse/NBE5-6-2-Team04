<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DevQuest Dashboard</title>
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <link rel="stylesheet" th:href="@{/css/common.css}">
  <link rel="stylesheet" th:href="@{/css/goal.css}">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
<div class="dashboard">

  <!--========= 좌측 사이드바 ===========-->
  <aside class="sidebar">
    <div class="logo">
      <span>DevQuest</span>
    </div>

    <h1 class="company-name" th:text="${company.companyName} + ' 개발자'">기업명 로딩 실패</h1>
    <span class="comment" th:text="${dashboard.comment}">한마디</span>
    <span class="nickname" th:text="${dashboard.nickname} + ' 님'">회원</span>

    <!-- 관심분야 태그 -->
    <div class="tags">
      <!-- 직무 -->
      <a class="tag" th:each="i : ${dashboard.roles}"
         th:href="${i.roadmapUrl}"
         th:text="'#' + ${i.interestName}"
         target="_blank">#직무</a>
      <a class="tag"
         th:if="${#lists.isEmpty(dashboard.roles)}"
         target="_blank">#직무 없음</a>

      <!-- 언어 -->
      <a class="tag" th:each="i : ${dashboard.devLangs}"
         th:href="${i.roadmapUrl}"
         th:text="'#' + ${i.interestName}"
         target="_blank">#언어</a>

      <!-- 프레임워크 -->
      <a class="tag" th:each="i : ${dashboard.frameworks}"
         th:href="${i.roadmapUrl}"
         th:text="'#' + ${i.interestName}"
         target="_blank">#프레임워크</a>
    </div>



      <!-- TODO: AI 데브 -->

    <div class="ai-box">
      <!-- AI 응답 표시 -->
      <p id="aiFeedBack">금쪽이 어서와~ 호호</p>

      <div class="button-row">
        <!-- 긍정 버튼 -->
        <button onclick="sendAiMessage('긍정적인 대답 및 네')" type="button" class="btn-positive" >긍정</button>

        <!-- 부정 버튼 -->
        <button onclick="sendAiMessage('부정적인 대답 및 아니요')" type="button" class="btn-negative">
          부정</button>
      </div>
    </div>


    <!-- 진행률 -->
    <div class="goal-item" th:each="goal : ${goals}">
      <div class="goal-info">
        <span class="goal-status" th:text="${goal.status}">상태</span>
        <span class="goal-title" th:text="${goal.title}">제목</span>

        <div class="goal-progress-text"
             th:if="${goal.progress != null}"
             th:text="'진행률: ' + ${goal.progress} + '%'">
          진행률 표시
        </div>

        <button class="goal-complete-btn"
                th:if="${goal.progress != null and goal.progress >= 100 and goal.isDone != null and !goal.isDone}"
                th:attr="data-id=${goal.goalId}">
          완료
        </button>
        <span th:text="'progress: ' + ${goal.progress} + ', isDone: ' + ${goal.isDone}">디버깅</span>

        <div class="progress-bar"
             th:if="${goal.progress != null}">
          <div class="progress-fill"
               th:style="'width:' + ${goal.progress} + '%'">
          </div>
        </div>
      </div>
    </div>
  </aside>

  <!--========== 목표 영역 ============-->
  <main class="main-content">
    <div class="menu">
      <a th:href="@{/dashboard}" th:text="대시보드"/>
      <a th:href="@{/user/mypage}" th:text="마이페이지"/>
      <a th:href="@{/logout}" th:text="로그아웃"/>
    </div>

    <div class="goal-list">
      <div th:each="goal : ${goals}" class="goal-card">
        <div class="card-header">
          <span class="status" th:text="${goal.isDone}? '완료' : '진행 중'">진행 상태</span>
          <p class="goal" th:text="${goal.title}">TODO 카테고리(goal name)</p>
        </div>

        <!-- 목표 카드 -->
        <div>
          <ul>
            <li class="todo-item" th:each="todo : ${todoMap[goal.goalId]}">
              <input type="checkbox"
                     th:checked="${todo.isDone}"
                     th:attr="data-id=${todo.todoId}">
              <span class="todo-content" th:text="${todo.content}">투두 내용</span>

              <div class="goal-actions">
                <button type="button" class="modify-todo-btn" th:attr="data-id=${todo.todoId}">수정
                </button>
                <button type="button" class="delete-todo-btn" th:attr="data-id=${todo.todoId}">삭제
                </button>
              </div>
            </li>
          </ul>
        </div>

        <div class="todo-actions">
          <button type="button" class="todo-modify-btn" th:attr="data-id=${goal.goalId}">수정</button>
          <button type="button" class="todo-delete-btn" th:attr="data-id=${goal.goalId}">삭제</button>
          <button type="button" class="todo-add-btn" th:attr="data-goal-id=${goal.goalId}">TODO 추가
          </button>
        </div>
      </div>

      <!-- 목표 생성 카드 -->
      <div class="company-card create goal-create-btn" onclick="openModal('goalModal')">
        <p class="goal-todo-desc-top">
          <span class="material-icons">control_point</span>
          목표 생성
        </p>

        <p class="goal-todo-desc-bottom">
          목표는 3개까지 무료로 생성이 가능합니다(4개 부터 유료^^)
        </p>
      </div>
    </div>
  </main>


  <!-- 목표  생성 모달 -->
  <div id="goalModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close" onclick="closeModal('goalModal')">&times;</span>
      <h2>목표 생성</h2>
      <form id="goal-form" th:attr="data-company-id=${company.companyId}">
        <input type="text" name="title" placeholder="목표를 입력해주세요" required><br><br>
        <label>시작일</label><br>
        <input type="date" name="startDate"><br><br>
        <label>마감일</label><br>
        <input type="date" name="endDate"><br><br>
        <button type="submit">생성</button>
      </form>
    </div>
  </div>

  <!-- todo 생성 모달 -->
  <div id="todoModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close" onclick="closeModal('todoModal')">&times;</span>
      <h2>todo 생성</h2>
      <form id="todo-form">
        <input type="text" name="title" placeholder="할 일을 입력해주세요" required><br><br>
        <input type="hidden" name="goalId">
        <button type="submit">추가</button>
      </form>
    </div>
  </div>

<script>
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    function getCsrfHeaders() {
      return {
        [csrfHeader]: csrfToken
      };
    }

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("goal-form");
      const todoForm = document.getElementById("todo-form");

      // goal 생성 이벤트
      document.querySelector(".goal-create-btn").addEventListener("click", () => {
        form.reset();
        form.removeAttribute("data-id");
        document.querySelector("#goalModal h2").textContent = "목표 추가";
        document.querySelector("#goalModal button[type='submit']").textContent = "추가";
        form.onsubmit = function (e) {
          e.preventDefault();
          createGoal();
        };
        openModal("goalModal");
      });

      // goal 수정 이벤트
      document.querySelectorAll(".update-goal-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const goalId = btn.dataset.id;
          fillGoalForm(goalId);
          form.setAttribute("data-id", goalId);
          document.querySelector("#goalModal h2").textContent = "목표 수정";
          document.querySelector("#goalModal button[type='submit']").textContent = "수정";
          form.onsubmit = function (e) {
            e.preventDefault();
            updateGoal(e);
          };
          openModal("goalModal");
        });
      });

      // goal 삭제 이벤트
      document.querySelectorAll(".delete-goal-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const goalId = btn.dataset.id;
          deleteGoal(goalId);
        });
      });

      // 목표 별 Todo 생성 이벤트

      document.querySelectorAll(".add-todo-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const goalId = btn.dataset.goalId;
          const form = document.getElementById("todo-form");
          form.reset();
          form.goalId.value = goalId;

          document.querySelector("#todoModal h2").textContent = "todo 생성";
          document.querySelector("#todoModal button[type='submit']").textContent = "추가";

          form.onsubmit = function (e) {
            e.preventDefault();
            createTodo();
          };

          openModal("todoModal");
        });
      });

      // 목표별 todo 수정 이벤트
      document.querySelectorAll(".update-todo-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const todoId = btn.dataset.id;
          fetch(`/todos/${todoId}/select`)
          .then(res => res.json())
          .then(data => {
            const form = document.getElementById("todo-form");
            form.reset();
            form.goalId.value = data.goalId; // 필요 시 포함
            form.title.value = data.content;

            document.querySelector("#todoModal h2").textContent = "todo 수정";
            document.querySelector("#todoModal button[type='submit']").textContent = "수정";

            openModal("todoModal");

            form.onsubmit = function (e) {
              e.preventDefault();
              updateTodo(todoId);
            };
          })
          .catch(err => {
            console.error("투두 불러오기 실패", err);
            alert("수정할 데이터를 불러오지 못했습니다.");
          });
        });
      });

      // 목표별 todo 삭제 이벤트
      document.querySelectorAll(".delete-todo-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const todoId = btn.dataset.id;
          deleteTodo(todoId);
        });
      });

      // todo 완요 toggle 이벤트
      document.querySelectorAll(".todo-checkbox").forEach(checkbox => {
        checkbox.addEventListener("change", () => {
          const todoId = checkbox.dataset.id;
          const isDone = checkbox.checked;
          toggleTodoStatus(todoId, isDone); // → 함수 분리!
        });
      });

    });

    // goal 생성 함수
    function createGoal() {
      const form = document.getElementById("goal-form");
      const companyId = form.dataset.companyId; // 필요시 상위에서 설정
      const data = {
        companyId: companyId,
        title: form.title.value,
        startDate: form.startDate.value,
        endDate: form.endDate.value
      };

      fetch(`/goals/${companyId}/create`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...getCsrfHeaders()
        },
        body: JSON.stringify(data)
      }).then(res => {
        if (res.ok) {
          alert("등록 완료!");
          closeModal("goalModal");
          location.reload();
        } else {
          alert("등록 실패");
        }
      }).catch(err => {
        console.error(err);
        alert("에러 발생");
      });
    }

    // goal 수정 함수
    function updateGoal(e) {
      const form = document.getElementById("goal-form");
      const goalId = form.dataset.id;

      const data = {
        title: form.title.value,
        startDate: form.startDate.value,
        endDate: form.endDate.value
      };

      fetch(`/goals/${goalId}/update`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          ...getCsrfHeaders()
        },
        body: JSON.stringify(data)
      }).then(res => {
        if (res.ok) {
          alert("수정 완료!");
          closeModal("goalModal");
          location.reload();
        } else {
          alert("수정 실패");
        }
      }).catch(err => {
        console.error(err);
        alert("수정 중 오류 발생");
      });
    }

    // goal 삭제 함수
    function deleteGoal(goalId) {
      if (confirm("정말 삭제하시겠습니까?")) {
        fetch(`/goals/${goalId}/delete`, {
          method: 'DELETE',
          headers: {
            ...getCsrfHeaders()
          }
        }).then(res => {
          if (res.ok) {
            alert("삭제 완료!");
            location.reload();
          } else {
            alert("삭제 실패");
          }
        }).catch(err => {
          console.error(err);
          alert("에러 발생");
        });
      }
    }

    //goal 불러오기 함수
    function fillGoalForm(goalId) {
      fetch(`/goals/${goalId}/select`)
      .then(res => res.json())
      .then(data => {
        const form = document.getElementById("goal-form");
        form.title.value = data.title;
        form.startDate.value = data.startDate;
        form.endDate.value = data.endDate;
      })
      .catch(err => {
        console.error("목표 불러오기 실패", err);
        alert("수정할 데이터를 불러오지 못했습니다.");
      });
    }

    // todo 생성 함수
    function createTodo() {

      const form = document.getElementById("todo-form");
      const goalId = form.goalId.value;
      const content = form.title.value;

      const data = {
        goalId: goalId,
        content: content
      };

      fetch(`/todos/${goalId}/create`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...getCsrfHeaders()
        },
        body: JSON.stringify(data)
      })
      .then(res => {
        if (res.ok) {
          alert("투두 추가 완료!");
          closeModal("todoModal");
          location.reload();
        } else {
          alert("추가 실패");
        }
      })
      .catch(err => {
        console.error("에러 발생", err);
        alert("에러 발생");
      });
    }

    // todo 수정 함수
    function updateTodo(todoId) {
      const form = document.getElementById("todo-form");
      const content = form.title.value;

      const data = {
        content: content
      };

      fetch(`/todos/${todoId}/update`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          ...getCsrfHeaders()
        },
        body: JSON.stringify(data)
      })
      .then(res => {
        if (res.ok) {
          alert("수정 완료!");
          closeModal("todoModal");
          location.reload();
        } else {
          alert("수정 실패");
        }
      })
      .catch(err => {
        console.error("수정 중 오류 발생", err);
        alert("에러 발생");
      });
    }

    // todo 삭제 함수
    function deleteTodo(todoId) {
      if (confirm("정말 삭제하시겠습니까?")) {
        fetch(`/todos/${todoId}/delete`, {
          method: 'DELETE',
          headers: {
            ...getCsrfHeaders()
          }
        })
        .then(res => {
          if (res.ok) {
            alert("삭제 완료!");
            location.reload();
          } else {
            alert("삭제 실패");
          }
        })
        .catch(err => {
          console.error("삭제 중 오류 발생", err);
          alert("에러 발생");
        });
      }
    }

    // todo 완료 toggle 함수
    function toggleTodoStatus(todoId, isDone) {
      const data = {
        isDone: isDone
      };

      fetch(`/todos/${todoId}/toggle`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          ...getCsrfHeaders()
        },
        body: JSON.stringify(data)
      })
      .then(res => {
        if (!res.ok) {
          throw new Error("업데이트 실패");
        }
        location.reload();
      })
      .catch(err => {
        console.error("체크박스 상태 변경 실패", err);
        alert("상태 변경 중 오류 발생");
      });
    }

    // goal modal 열기 함수
    function openModal(goalModal) {
      document.getElementById(goalModal).style.display = "flex";
    }

    // goal modal 닫기 함수
    function closeModal(goalModal) {
      document.getElementById(goalModal).style.display = "none";
    }

    function openTodoModal(goalId) {
      const form = document.getElementById("todo-form");
      form.reset();
      form.goalId.value = goalId;
      openModal("todoModal");
    }

    function closeTodoModal() {
      const form = document.getElementById("todo-form");
      form.reset();

      closeModal("todoModal");
    }

    //Gemini 답장 메시지

    function sendAiMessage(message) {
      const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

      fetch("/api/ai/feedback", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          [csrfHeader]: csrfToken
        },
        body: JSON.stringify({ prompt: message })
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById("aiFeedBack").textContent = data.reply;
      })
      .catch(err => {
        console.error("AI 응답 실패", err);
        alert("AI 응답 중 오류발생");
      });
    }

  </script>

</div>
</body>
</html>