<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>DevQuest Dashboard</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <!--  <link rel="stylesheet" th:href="@{/css/dashboard.css}">-->
    <link rel="stylesheet" th:href="@{/css/goal.css}">
    <link rel="stylesheet" th:href="@{/css/achievement/congratulation.css}">
    <link rel="stylesheet" th:href="@{/css/levelup.css}">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>
<h1>목표 기업 상세 페이지입니다</h1>
<p th:text="'기업명: ' + ${company.companyName}">기업명 로딩 실패</p>

<div id="logo-container"></div>
<div class="dashboard">

    <!-- 좌측 사이드바 -->
    <aside class="sidebar">
        <h1 class="logo">
            <a style="text-decoration: none; color:inherit;" th:href="@{/static}">
                DevQuest
            </a>
        </h1>
        <div class="createdAt-comment">
            <span class="day-count" th:text="${dashboard.dayCount} + '일째'">N 일째</span>
            <span class="comment" th:text="${dashboard.comment}">슬로건</span>
        </div>
        <span class="nickname" th:text="${dashboard.nickname}">회원</span>
        <span class="nickname-sir">님</span>

        <!-- 관심분야 태그 -->
        <div class="tags">
            <!-- 직무 -->
            <a class="tag" target="_blank"
               th:each="i : ${dashboard.roles}"
               th:href="${i.roadmapUrl}"
               th:text="'#' + ${i.interestName}">#직무</a>
            <a class="tag"
               target="_blank"
               th:if="${#lists.isEmpty(dashboard.roles)}">#직무 없음</a>

            <!-- 언어 -->
            <a class="tag" target="_blank"
               th:each="i : ${dashboard.devLangs}"
               th:href="${i.roadmapUrl}"
               th:text="'#' + ${i.interestName}">#언어</a>

            <!-- 프레임워크 -->
            <a class="tag" target="_blank"
               th:each="i : ${dashboard.frameworks}"
               th:href="${i.roadmapUrl}"
               th:text="'#' + ${i.interestName}">#프레임워크</a>
        </div>

        <!--  마이페이지  -->
        <p class="mypage">
            <a style="text-decoration: none; color: inherit;" th:href="@{/user/mypage}">
                <span class="material-icons">account_circle</span>마이페이지
            </a>
        </p>

        <!-- 프로필 카드 -->
        <div class="profile-card">
            <div class="profile-card">
                <!--        <div class="profile-info">-->
                <!--          <img class="profile-img"-->
                <!--               th:src="${dashboard.userImage != null && !dashboard.userImage.isEmpty()-->
                <!--             ? '/images/profile/' + dashboard.userImage-->
                <!--             : '/images/profile/default.png'}"-->
                <!--               alt="프로필 이미지"/>-->

                <!--          <div class="level-info">-->
                <!--            <p class="level-label" th:text="${dashboard.levelName}">레벨명</p>-->
                <!--            <p class="level-value" th:text="'Lv.' + ${dashboard.levelValue}">Lv.N</p>-->
                <!--          </div>-->
                <!--        </div>-->

                <!--  xp 진행바  -->
                <div class="xp-label" th:text="${dashboard.exp} + 'xp'">N xp</div>
                <div class="xp-bar">
                    <div class="xp-progress"
                         th:style="'width:' + (${dashboard.exp} > 100 ? 100 : dashboard.exp) + '%'">
                        <span th:text="${dashboard.exp} + 'xp'"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="goal-item" th:each="goal : ${goals}">
            <div class="goal-info">
                <span class="goal-status" th:text="${goal.status}">상태</span>
                <span class="goal-title" th:text="${goal.title}">제목</span>
                <span class="done-label" th:if="${goal.isDone}">(완료)</span>

                <div class="goal-progress-text"
                     th:if="${goal.progress != null}"
                     th:text="'진행률: ' + ${goal.progress} + '%'">
                    진행률 표시
                </div>

                <button class="goal-complete-btn"
                        th:attr="data-id=${goal.goalId}"
                        th:if="${goal.progress != null and goal.progress >= 100 and goal.isDone == false}">
                    완료
                </button>

                <div class="progress-bar"
                     th:if="${goal.progress != null}">
                    <div class="progress-fill"
                         th:style="'width:' + ${goal.progress} + '%'">
                    </div>
                </div>
            </div>
        </div>

    </aside>

    <!-- 메인 영역 -->
    <main class="main-content">
        <div class="logout">
            <a style="text-decoration: none; color: inherit;" th:href="@{/logout}">
                로그아웃
            </a>
        </div>

        <!--  Goal List   -->
        <p class="section-title" th:text="${company.companyName}">Goal List</p>

        <div class="goal-list">
            <div class="goal-card" th:each="goal : ${goals}">


                <div class="card-header">
                    <span class="status" th:text="${goal.isDone}? '완료' : '진행 중'">진행 상태</span>
                    <p class="company-name" th:text="${goal.title}">회사명</p>
                </div>

                <!-- 목표 카드 -->
                <div class="status-dday">
                    <ul>
                        <li th:each="todo : ${todoMap[goal.goalId]}">

                            <input class="todo-checkbox"
                                   th:attr="data-id=${todo.todoId}"
                                   th:checked="${todo.isDone}"
                                   type="checkbox">
                            <span th:text="${todo.content}">투두 내용</span>

                            <div class="goal-actions">
                                <button class="update-todo-btn" th:attr="data-id=${todo.todoId}" type="button">수정
                                </button>
                                <button class="delete-todo-btn" th:attr="data-id=${todo.todoId}" type="button">삭제
                                </button>
                            </div>
                        </li>
                    </ul>
                </div>
                <div class="todo-actions">
                    <button class="update-goal-btn" th:attr="data-id=${goal.goalId}" type="button">수정</button>
                    <button class="delete-goal-btn" th:attr="data-id=${goal.goalId}" type="button">삭제</button>
                    <button class="add-todo-btn" th:attr="data-goal-id=${goal.goalId}" type="button">투두 추가</button>
                </div>
            </div>

            <!-- 목표 생성 카드 -->
            <div class="goal-card create goal-create-btn" onclick="openModal('goalModal')">
                <p class="goal-todo-desc-top">
                    <span class="material-icons">control_point</span>
                    목표 생성
                </p>

                <p class="goal-todo-desc-bottom">
                    목표는 3개까지 무료로 생성이 가능합니다(4개 부터 유료^^)
                </p>
            </div>
        </div>
    </main>


    <!-- 목표  생성 모달 -->
    <div class="modal" id="goalModal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal('goalModal')">&times;</span>
            <h2>목표 생성</h2>
            <form id="goal-form" th:attr="data-company-id=${company.companyId}">
                <input name="title" placeholder="목표를 입력해주세요" required type="text"><br><br>
                <label>시작일</label><br>
                <input name="startDate" type="date"><br><br>
                <label>마감일</label><br>
                <input name="endDate" type="date"><br><br>
                <button type="submit">생성</button>
            </form>
        </div>
    </div>

    <!-- todo  생성 모달 -->
    <div class="modal" id="todoModal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal('todoModal')">&times;</span>
            <h2>todo 생성</h2>
            <form id="todo-form">
                <input name="title" placeholder="할 일을 입력해주세요" required type="text"><br><br>
                <input name="goalId" type="hidden">
                <button type="submit">추가</button>
            </form>
        </div>
    </div>
    <div th:replace="~{fragments/achievement-modal :: achievementModal}"></div>
    <div th:replace="~{fragments/levelup-modal :: levelUpModal}"></div>
  <div id="tsparticles"
       style="position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 9999;
            pointer-events: none;
            display: none;"></div>

    <script>
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        function getCsrfHeaders() {
            return {
                [csrfHeader]: csrfToken
            };
        }

        // 이벤트 모음

        // 목표 완료 이벤트
        document.querySelectorAll('.goal-complete-btn').forEach(button => {
            button.addEventListener('click', handleGoalCompleteClick);
        });

        // 목표 완료 이벤트 핸들러
        function handleGoalCompleteClick(event) {
            const goalId = event.currentTarget.getAttribute('data-id');

            if (confirm('정말 목표를 완료하시겠습니까?')) {
                goalComplete(goalId);
            }
        }

        // 목표 완료 함수
        function goalComplete(goalId) {
            fetch(`/goals/${goalId}/complete`, {
                method: 'POST',
                headers: {...getCsrfHeaders()}
            })
                .then(response => response.json())
                .then(data => {
                    if (data.leveledUp) {
                        // 모달 띄우기
                        // document.getElementById('levelUpModal').style.display = 'flex';
                        // document.getElementById('levelUpText').innerText = `축하합니다! ${data.newLevelName}로 레벨업 했어요!`;
                        showLevelUpModal(data.newLevelName, data.newLevelId);
                        setTimeout(() => {
                            document.getElementById('levelUpModal').style.display = 'none';
                            location.reload();
                        }, 4000);
                    } else {
                        alert('목표 완료! 경험치 +10');
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('에러 발생:', error);
                    alert('요청 중 오류가 발생했습니다.');
                });
        }

        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("goal-form");
            const todoForm = document.getElementById("todo-form");

            // goal 생성 이벤트
            document.querySelector(".goal-create-btn").addEventListener("click", () => {
                form.reset();
                form.removeAttribute("data-id");
                document.querySelector("#goalModal h2").textContent = "목표 추가";
                document.querySelector("#goalModal button[type='submit']").textContent = "추가";
                form.onsubmit = function (e) {
                    e.preventDefault();
                    createGoal();
                };
                openModal("goalModal");
            });

            // goal 수정 이벤트
            document.querySelectorAll(".update-goal-btn").forEach(btn => {
                btn.addEventListener("click", async () => {
                    const goalId = btn.dataset.id;

                    await fillGoalForm(goalId);

                    form.setAttribute("data-id", goalId);
                    document.querySelector("#goalModal h2").textContent = "목표 수정";
                    document.querySelector("#goalModal button[type='submit']").textContent = "수정";


                    form.onsubmit = function (e) {
                        e.preventDefault();
                        updateGoal(e);
                    };
                    openModal("goalModal");
                });
            });

            // goal 삭제 이벤트
            document.querySelectorAll(".delete-goal-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const goalId = btn.dataset.id;
                    deleteGoal(goalId);
                });
            });

            // 목표 별 투두 생성 이벤트
            document.querySelectorAll(".add-todo-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const goalId = btn.dataset.goalId;
                    const form = document.getElementById("todo-form");
                    form.reset();
                    form.goalId.value = goalId;

                    document.querySelector("#todoModal h2").textContent = "todo 생성";
                    document.querySelector("#todoModal button[type='submit']").textContent = "추가";


                    form.onsubmit = function (e) {
                        e.preventDefault();
                        createTodo();
                    };

                    openModal("todoModal");
                });
            });


            // 목표별 투두 수정 이벤트
            document.querySelectorAll(".update-todo-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const todoId = btn.dataset.id;
                    fetch(`/todos/${todoId}/select`)
                        .then(res => res.json())
                        .then(data => {
                            const form = document.getElementById("todo-form");
                            form.reset();
                            form.goalId.value = data.goalId; // 필요 시 포함
                            form.title.value = data.content;

                            document.querySelector("#todoModal h2").textContent = "todo 수정";
                            document.querySelector("#todoModal button[type='submit']").textContent = "수정";

                            openModal("todoModal");

                            form.onsubmit = function (e) {
                                e.preventDefault();
                                updateTodo(todoId);
                            };
                        })
                        .catch(err => {
                            console.error("투두 불러오기 실패", err);
                            alert("수정할 데이터를 불러오지 못했습니다.");
                        });
                });
            });

            // 목표별 투두 삭제 이벤트
            document.querySelectorAll(".delete-todo-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const todoId = btn.dataset.id;
                    deleteTodo(todoId);
                });
            });

            // 투두 완료 toggle 이벤트
            document.querySelectorAll(".todo-checkbox").forEach(checkbox => {
                checkbox.addEventListener("change", () => {
                    const todoId = checkbox.dataset.id;
                    toggleTodoStatus(todoId);
                });
            });

        });

        // goal 생성 함수
        function createGoal() {
            const form = document.getElementById("goal-form");
            const companyId = form.dataset.companyId;

            const data = {
                companyId: companyId,
                title: form.title.value,
                startDate: form.startDate.value,
                endDate: form.endDate.value
            };

            fetch(`/goals/${companyId}/create`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...getCsrfHeaders()
                },
                body: JSON.stringify(data)
            })
                .then(res => {
                    if (!res.ok) throw new Error("등록 실패");
                    return res.json(); // JSON으로 파싱
                })
                .then(result => {
                    closeModal("goalModal");

                    const baseUrl = `${window.location.origin}${window.location.pathname}`;

                    if (result.achievementName) {
                        // 업적 획득 시 → 축하 모달 띄우기 위한 리다이렉트
                        const encodedName = encodeURIComponent(result.achievementName);
                        const redirectUrl = `${baseUrl}?achievementName=${encodedName}`;
                        window.location.href = redirectUrl;
                    } else {
                        // 업적 없으면 기존대로 동작
                        alert("등록 완료!");
                        location.reload();
                    }
                })
                .catch(err => {
                    console.error("에러 발생:", err);
                    alert("에러 발생");
                });
        }

        // goal 수정 함수
        function updateGoal(e) {
            const form = document.getElementById("goal-form");
            const goalId = form.dataset.id;

            const data = {
                title: form.title.value,
                startDate: form.startDate.value,
                endDate: form.endDate.value
            };

            fetch(`/goals/${goalId}/update`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    ...getCsrfHeaders()
                },
                body: JSON.stringify(data)
            }).then(res => {
                if (res.ok) {
                    alert("수정 완료!");
                    closeModal("goalModal");
                    location.reload();
                } else {
                    alert("수정 실패");
                }
            }).catch(err => {
                console.error(err);
                alert("수정 중 오류 발생");
            });
        }

        // goal 삭제 함수
        function deleteGoal(goalId) {
            if (confirm("정말 삭제하시겠습니까?")) {
                fetch(`/goals/${goalId}/delete`, {
                    method: 'DELETE',
                    headers: {
                        ...getCsrfHeaders()
                    }
                }).then(res => {
                    if (res.ok) {
                        alert("삭제 완료!");
                        location.reload();
                    } else {
                        alert("삭제 실패");
                    }
                }).catch(err => {
                    console.error(err);
                    alert("에러 발생");
                });
            }
        }

        //goal 불러오기 함수
        function fillGoalForm(goalId) {
            fetch(`/goals/${goalId}/select`)
                .then(res => res.json())
                .then(data => {
                    const form = document.getElementById("goal-form");
                    form.title.value = data.title ?? '';        // null-safe 처리 (에러 방지)
                    form.startDate.value = data.startDate ?? '';
                    form.endDate.value = data.endDate ?? '';
                })
                .catch(err => {
                    console.error("목표 불러오기 실패", err);
                    alert("수정할 데이터를 불러오지 못했습니다.");
                });
        }

        // 함수 모음


        // 투두 생성 함수
        function createTodo() {

            const form = document.getElementById("todo-form");
            const goalId = form.goalId.value;
            const content = form.title.value;

            const data = {
                goalId: goalId,
                content: content
            };

            fetch(`/todos/${goalId}/create`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...getCsrfHeaders()
                },
                body: JSON.stringify(data)
            })
                .then(res => {
                    if (res.ok) {
                        alert("투두 추가 완료!");
                        closeModal("todoModal");
                        location.reload();
                    } else {
                        alert("추가 실패");
                    }
                })
                .catch(err => {
                    console.error("에러 발생", err);
                    alert("에러 발생");
                });
        }

        // 투두 수정 함수
        function updateTodo(todoId) {
            const form = document.getElementById("todo-form");
            const content = form.title.value;

            const data = {
                content: content
            };

            fetch(`/todos/${todoId}/update`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    ...getCsrfHeaders()
                },
                body: JSON.stringify(data)
            })
                .then(res => {
                    if (res.ok) {
                        console.log("aaaaa", res);
                        alert("수정 완료!");
                        closeModal("todoModal");
                        location.reload();
                    } else {
                        alert("수정 실패");
                    }
                })
                .catch(err => {
                    console.error("수정 중 오류 발생", err);
                    alert("에러 발생");
                });
        }


        // 투두 삭제 함수
        function deleteTodo(todoId) {
            if (confirm("정말 삭제하시겠습니까?")) {
                fetch(`/todos/${todoId}/delete`, {
                    method: 'DELETE',
                    headers: {
                        ...getCsrfHeaders()
                    }
                })
                    .then(res => {
                        if (res.ok) {
                            alert("삭제 완료!");
                            location.reload();
                        } else {
                            alert("삭제 실패");
                        }
                    })
                    .catch(err => {
                        console.error("삭제 중 오류 발생", err);
                        alert("에러 발생");
                    });
            }
        }

        // 투두 완료 toggle 함수 (업적 확인 포함)
        function toggleTodoStatus(todoId) {
            fetch(`/todos/${todoId}/toggle-check`, {
                method: 'POST',
                headers: {
                    ...getCsrfHeaders()
                }
            })
                .then(res => {
                    if (!res.ok) throw new Error("업적 확인 실패");
                    return res.json();
                })
                .then(data => {
                    if (data.achievementName) {
                        const baseUrl = `${window.location.origin}${window.location.pathname}`;
                        const redirectUrl = `${baseUrl}?achievementName=${encodeURIComponent(data.achievementName)}`;
                        window.location.href = redirectUrl;
                    } else {
                        // 업적이 없는 경우는 단순 리로드
                        location.reload();
                    }
                })
                .catch(err => {
                    console.error("체크박스 상태 변경 실패", err);
                    alert("상태 변경 중 오류 발생");
                });
        }

        // goal modal 열기 함수
        function openModal(goalModal) {
            document.getElementById(goalModal).style.display = "flex";
        }

        // goal modal 닫기 함수
        function closeModal(goalModal) {
            document.getElementById(goalModal).style.display = "none";
        }

        function openTodoModal(goalId) {
            const form = document.getElementById("todo-form");
            form.reset();
            form.goalId.value = goalId;
            openModal("todoModal");
        }

        function closeTodoModal() {
            const form = document.getElementById("todo-form");
            form.reset();

            closeModal("todoModal");
        }

    </script>
</body>
<script defer src="/js/achievement/congratulation.js"></script>
<script
        src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
<script defer src="/js/level/level.js"></script>
</html>