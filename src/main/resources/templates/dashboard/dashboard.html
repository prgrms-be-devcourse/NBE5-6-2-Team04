<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>DevQuest Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>
<div class="dashboard">

    <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°” -->
    <aside class="sidebar">
        <div class="createdAt-comment">
            <span class="day-count" th:text="${dashboard.dayCount} + 'ì¼ì§¸'">N ì¼ì§¸</span>
            <span class="comment" th:text="${dashboard.comment}">ìŠ¬ë¡œê±´</span>
        </div>
        <span class="nickname" th:text="${dashboard.nickname}">íšŒì›</span>
        <span class="nickname-sir">ë‹˜</span>

        <!--  ê´€ì‹¬ë¶„ì•¼ íƒœê·¸  -->
        <div class="tags">
      <span class="tag"
            th:if="${dashboard.jobType != null and !dashboard.jobType.isEmpty()}"
            th:text="'#' + ${dashboard.jobType[0]}">#ì§ë¬´</span>
            <span class="tag"
                  th:unless="${dashboard.jobType != null and !dashboard.jobType.isEmpty()}">#ì§ë¬´ ì—†ìŒ</span>

            <span class="tag" th:each="lang : ${dashboard.devLang}" th:text="'#' + ${lang}">#ì–¸ì–´</span>
            <span class="tag" th:each="fw : ${dashboard.framework}" th:text="'#' + ${fw}">#í”„ë ˆì„ì›Œí¬</span>
        </div>

        <!--  ë§ˆì´í˜ì´ì§€  -->
        <p class="mypage">
            <a th:href="@{/users/mypage}">
                <span class="material-icons">account_circle</span>ë§ˆì´í˜ì´ì§€
            </a>
        </p>

        <!-- í”„ë¡œí•„ ì¹´ë“œ -->
        <div class="profile-card">
            <div class="profile-card">
                <div class="profile-info">
                    <img alt="í”„ë¡œí•„ ì´ë¯¸ì§€"
                         class="profile-img"
                         th:src="${dashboard.userImage != null && !dashboard.userImage.isEmpty()
             ? '/images/profile/' + dashboard.userImage
             : '/images/profile/default.png'}"/>

                    <div class="level-info">
                        <p class="level-label" th:text="${dashboard.levelName}">ë ˆë²¨ëª…</p>
                        <p class="level-value" th:text="'Lv.' + ${dashboard.levelValue}">Lv.N</p>
                    </div>
                </div>

                <!--  xp ì§„í–‰ë°”  -->
                <div class="xp-label" th:text="${dashboard.exp} + 'xp'">N xp</div>
                <div class="xp-bar">
                    <div class="xp-progress"
                         th:style="'width:' + (${dashboard.exp} > 100 ? 100 : dashboard.exp) + '%'">
                        <span th:text="${dashboard.exp} + 'xp'"></span>
                    </div>
                </div>
            </div>
        </div>

        <!--  ì•Œë¦¼ í† ê¸€  -->
        <div class="toggle-box">
            <form method="post" th:action="@{/dashboard/notification-toggle}">
                <!-- ì„œí˜„ë‹˜ csrf í† í° ì¶”ê°€ í›„ ì£¼ì„í•´ì œ -->
                <!-- <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>-->
                <input name="notification"
                       onchange="this.form.submit()"
                       th:checked="${dashboard.notificationOn}" type="checkbox">
                <label>ì•Œë¦¼</label>
            </form>
        </div>

        <!--  ì£¼ìš”ì•Œë¦¼  -->
        <div class="alert-box">
            <h3>
                ğŸ”” ì£¼ìš” ì•Œë¦¼
                <span class="count" th:text="${#lists.size(dashboard.goalCompanies)}">0</span>
            </h3>
            <ul th:if="${dashboard.notificationOn}">
                <li th:each="company : ${dashboard.goalCompanies}">
                    <span class="material-icons">access_alarms</span>
                    <strong th:text="${company.companyName} + ' - '">ê¸°ì—…ëª…</strong>
                    <span th:text="${company.statusLabel != null ? company.statusLabel : 'ìƒíƒœì—†ìŒ'}">ìƒíƒœ</span>
                    <span th:text="${company.DDay == 0} ? 'ì…ë‹ˆë‹¤. ğŸ£' : 'D-' + ${company.DDay} + ' ì¼ ì…ë‹ˆë‹¤.'">ì¼ ì…ë‹ˆë‹¤. ğŸ£</span>
                </li>
            </ul>
            <p th:unless="${dashboard.notificationOn}">
                í˜„ì¬ ì•Œë¦¼ì´ êº¼ì ¸ ìˆì–´ìš” ğŸ”•
            </p>
        </div>
    </aside>

    <!-- ë©”ì¸ ì˜ì—­ -->
    <main class="main-content">

        <!--  Company List   -->
        <p class="section-title">Company List</p>

        <div class="company-list">
            <a class="company-card"
               th:classappend="|
                         ${company.companyName.toLowerCase()}
                         ${(company.companyName == 'ë„¤ì´ë²„') ? ' naver' : ''}
                         ${(company.companyName == 'í† ìŠ¤') ? ' toss' : ''}
                         ${(company.companyName == 'ë‹¹ê·¼') ? ' danggeun' : ''}
                         ${(company.companyName == 'ë°°ë‹¬ì˜ë¯¼ì¡±') ? ' baemin' : ''}
                         ${(company.companyName == 'ì¹´ì¹´ì˜¤') ? ' kakao' : ''}
                       |"
               th:each="company : ${dashboard.goalCompanies}"
               th:href="@{/companies/{companyId}/select(companyId=${company.companyId})}">


                <div class="card-header">
                    <span class="status" th:text="${company.statusLabel}">ì§„í–‰ ìƒíƒœ</span>
                    <span class="dday" th:text="'D-' + ${company.DDay}">D-day</span>

                    <!-- ìˆ˜ì •/ì‚­ì œ ë“œë¡­ë‹¤ìš´  -->
                    <div class="dropdown">
                        <button class="dropdown-toggle" type="button">â‹®</button>
                        <ul class="dropdown-menu">
                            <li>ìˆ˜ì •</li>
                            <li th:onclick="'deleteCompany(' + ${company.companyId} + ')'">ì‚­ì œ</li>
                        </ul>
                    </div>
                </div>

                <!-- ëª©í‘œ ê¸°ì—… ì¹´ë“œ -->
                <p class="company-name" th:text="${company.companyName}">íšŒì‚¬ëª…</p>
                <p class="content" th:text="${company.content}">ë‚´ìš©</p>
                <div class="status-dday">
                    <span class="status" th:text="${company.statusLabel}">ì§„í–‰ ìƒíƒœ</span>
                    <span class="endDate" th:text="'~' + ${company.endDate}">~ë§ˆê°ì¼</span>
                </div>
            </a>

            <!-- TODO ìƒì„± ì¹´ë“œ -->
            <div class="company-card create" onclick="openModal('companyModal')">
                <p class="goal-todo-desc-top">
                    <span class="material-icons">control_point</span>
                    ëª©í‘œ ê¸°ì—… TODO ìƒì„±
                </p>

                <p class="goal-todo-desc-bottom">
                    ëª©í‘œ ê¸°ì—…ì€ ìµœëŒ€ 3ê°œê¹Œì§€ ìƒì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.
                </p>
            </div>
        </div>
    </main>
</div>

<!-- ëª©í‘œ ê¸°ì—… ìƒì„± ëª¨ë‹¬ -->
<div class="modal" id="companyModal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeModal('companyModal')">&times;</span>
        <h2>ëª©í‘œ ê¸°ì—… ìƒì„±</h2>
        <form id="create-form">
            <input name="companyName" placeholder="ê¸°ì—…ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" required type="text"><br><br>
            <input name="content" placeholder="ì–´ë–¤ ê°œë°œìê°€ ë˜ê³  ì‹¶ì€ì§€ í•œë§ˆë””" required type="text"><br><br>
            <label>ì¼ì •</label><br>
            <select name="status">
                <option value="DOCUMENT">ì„œë¥˜ ë§ˆê°</option>
                <option value="CODING_TEST">ì½”ë”©í…ŒìŠ¤íŠ¸</option>
                <option value="ASSIGNMENT">ê³¼ì œ</option>
                <option value="APTITUDE">ì¸ì ì„±ê²€ì‚¬</option>
                <option value="INTERVIEW_1">1ì°¨ ë©´ì ‘</option>
                <option value="INTERVIEW_2">2ì°¨ ë©´ì ‘</option>
                <option value="INTERVIEW_3">3ì°¨ ë©´ì ‘ (ì»¬ì²˜í•)</option>
            </select><br><br>
            <label>ë§ˆê°ì¼</label><br>
            <input name="endDate" type="date"><br><br>
            <button type="submit">ìƒì„±</button>
        </form>
    </div>
</div>
<div th:replace="~{fragments/achievement-modal :: achievementModal}"></div>

<script>
    // ë“œë¡­ë‹¤ìš´(ìˆ˜ì •, ì‚­ì œ)
    document.addEventListener('DOMContentLoaded', () => {
        const toggles = document.querySelectorAll('.dropdown-toggle');

        toggles.forEach((toggle) => {
            toggle.addEventListener('click', (e) => {
                e.stopPropagation(); // ë‹¤ë¥¸ ê³³ í´ë¦­ ë§‰ê¸°
                // ëª¨ë“  ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    if (menu !== toggle.nextElementSibling) {
                        menu.style.display = 'none';
                    }
                });
                // í˜„ì¬ ê²ƒë§Œ í† ê¸€
                const menu = toggle.nextElementSibling;
                menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';

                const items = menu.querySelectorAll('li');
                items.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.stopPropagation(); // ìˆ˜ì •, ì‚­ì œ ëˆŒëŸ¬ë„ ìƒì„¸ ì§„ì… ì•ˆ ë¨
                    });
                });
            });
        });

        // í˜ì´ì§€ ì–´ë””ë“  í´ë¦­í•˜ë©´ ë©”ë‰´ ë‹«í˜
        document.addEventListener('click', () => {
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.style.display = 'none';
            });
        });
    });
</script>

<!-- ëª©í‘œ ê¸°ì—… ìƒì„± ëª¨ë‹¬ -->
<script>
    function openModal(companyModal) {
        document.getElementById(companyModal).style.display = "flex";
    }

    function closeModal(companyModal) {
        document.getElementById(companyModal).style.display = "none";
    }

</script>

<!--ëª©í‘œ ê¸°ì—… ìƒì„± ëª¨ë‹¬(post ë³´ë‚´ê¸°)-->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("create-form");

        form.addEventListener("submit", function (e) {
            e.preventDefault();

            const data = {
                companyName: form.companyName.value,
                content: form.content.value,
                status: form.status.value,
                endDate: form.endDate.value
            };

            fetch('/companies', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
                    .then(res => {
                      if (!res.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
                      return res.json(); // âœ… JSON ì‘ë‹µ íŒŒì‹±
                    })
                    .then(result => {
                      closeModal('companyModal'); // âœ… ëª¨ë‹¬ ë¨¼ì € ë‹«ìŒ
                      const baseUrl = window.location.origin + window.location.pathname;
                      if (result.achievementName) {
                        // âœ… ì—…ì ì´ ìˆì„ ê²½ìš° ëª¨ë‹¬ë¡œ ì¶•í•˜
                        const redirectUrl = `${baseUrl}?achievementName=${encodeURIComponent(result.achievementName)}`;
                        window.location.href = redirectUrl;
                      } else {
                        // âœ… ì—…ì  ì—†ì„ ê²½ìš° ê¸°ì¡´ íë¦„ ìœ ì§€
                        alert("ë“±ë¡ ì™„ë£Œ!");
                        window.location.reload();
                      }
                    })
                .catch(err => {
                        console.error(err);
                        alert("ì—ëŸ¬ ë°œìƒ");
                    });
                });
        });

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }
</script>

// ì‚­ì œ ê¸°ëŠ¥
<script>
    function deleteCompany(companyId) {
        console.log("ì‚­ì œ ìš”ì²­ ID:", companyId);
        if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            fetch(`/companies/${companyId}/delete`, {
                method: 'DELETE'
            })
                .then(res => {
                    if (res.ok) {
                        alert("ì‚­ì œ ì™„ë£Œ!");
                        window.location.reload(); // ìƒˆë¡œê³ ì¹¨
                    } else {
                        alert("ì‚­ì œ ì‹¤íŒ¨");
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("ì—ëŸ¬ ë°œìƒ");
                });
        }
    }
</script>

</body>
<script defer src="/js/achievement/congratulation.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
</html>