<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DevQuest 관리자 페이지</title>

  <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="/css/common.css">
  <link rel="stylesheet" href="/css/header.css">
  <link rel="stylesheet" href="/css/adminDashboard.css">
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>
<main>
  <h2><b th:text="${nickname} + ' 님, 안녕하세요!'">관리자님 안녕하세요!</b></h2>

  <div class="container">
    <h2 class="member-title">
      <i class="material-icons" style="vertical-align: middle; margin-right: 6px;">supervisor_account</i>
      User List
    </h2>

    <div class="tabs">
      <a href="#" class="tab-btn" onclick="showTab('admin-users'); return false;">관리자</a>
      <a href="#" class="tab-btn active" onclick="showTab('active-users'); return false;">현재 회원</a>
      <a href="#" class="tab-btn" onclick="showTab('deleted-users'); return false;">탈퇴 회원</a>
    </div>

    <hr/>

    <div class="card">
      <table id="user-table" class="display" style="width:100%">
        <thead>
        <tr>
          <th><input type="checkbox" id="select-all"/></th>
          <th>번호</th>
          <th>사용자</th>
          <th>가입일</th>
          <th>권한</th>
          <th>관리</th>
        </tr>
        </thead>

        <!-- 현재 회원 -->
        <tbody id="active-users">
        <tr th:each="user, iterStat : ${activeUsers}">
          <td><input type="checkbox" name="userCheck"/></td>
          <td th:text="${iterStat.count}">1</td>
          <td>
            <div th:text="${user.nickname}">닉네임</div>
            <span class="email-small" th:text="${user.email}">user@example.com</span>
          </td>
          <td th:text="${user.createdAt}">2025-05-15</td>
          <td>
            <span th:if="${user.role.name() == 'ROLE_ADMIN'}" class="role-admin">관리자</span>
            <span th:unless="${user.role.name() == 'ROLE_ADMIN'}"></span>
          </td>
          <td>
            <form th:action="@{/admin/removeUser}" method="post">
              <input type="hidden" name="email" th:value="${user.email}"/>
              <button type="submit" onclick="return confirm('정말 삭제하시겠습니까?');">삭제</button>
            </form>
          </td>
        </tr>
        </tbody>

        <!-- 관리자 -->
        <tbody id="admin-users" style="display:none;">
        <tr th:each="user, iterStat : ${adminUsers}">
          <td><input type="checkbox" name="userCheck"/></td>
          <td th:text="${iterStat.count}">1</td>
          <td>
            <div th:text="${user.nickname}">닉네임</div>
            <span class="email-small" th:text="${user.email}">user@example.com</span>
          </td>
          <td th:text="${user.createdAt}">2025-05-15</td>
          <td><span class="role-admin">관리자</span></td>
          <td>
            <form th:action="@{/admin/removeUser}" method="post">
              <input type="hidden" name="email" th:value="${user.email}"/>
              <button type="submit" onclick="return confirm('정말 삭제하시겠습니까?');">삭제</button>
            </form>
          </td>
        </tr>
        </tbody>

        <!-- 탈퇴 회원 -->
        <tbody id="deleted-users" style="display:none;">
        <tr th:each="user, iterStat : ${deletedUsers}">
          <td><input type="checkbox" name="userCheck"/></td>
          <td th:text="${iterStat.count}">1</td>
          <td>
            <div th:text="${user.nickname}">닉네임</div>
            <span class="email-small" th:text="${user.email}">user@example.com</span>
          </td>
          <td th:text="${user.createdAt}">2025-05-15</td>
          <td>
            <span th:if="${user.role.name() == 'ROLE_ADMIN'}" class="role-admin">관리자</span>
            <span th:unless="${user.role.name() == 'ROLE_ADMIN'}"></span>
          </td>
          <td>
            <span style="color: #888;">탈퇴</span><br/>
            <span class="email-small"
                  th:text="${#temporals.format(user.deletedAt, 'yyyy-MM-dd')}"></span>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
</main>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
  function showTab(tabId) {
    ['admin-users', 'active-users', 'deleted-users'].forEach(id => {
      const tbody = document.getElementById(id);
      if (tbody) {
        tbody.style.display = (id === tabId ? '' : 'none');
      }
    });
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.querySelector(`.tab-btn[onclick*="${tabId}"]`);
    if (activeBtn) {
      activeBtn.classList.add('active');
    }
  }

  $(document).ready(function () {
    const table = $('#user-table').DataTable({
      language: {
        info: "_START_ - _END_ / 총 _TOTAL_명",
      },
      paging: true,
      searching: true,
      ordering: true,
      info: true,
      columnDefs: [
        {orderable: false, targets: 0}
      ],
      scrollY: '400px',
      scrollCollapse: false
    });
    // search bar
    $('#user-table_filter input[type="search"]').attr('placeholder', '검색어를 입력하세요.');

    // 전체 선택 체크박스
    $('#select-all').on('click', function () {
      const rows = table.rows({'search': 'applied'}).nodes();
      $('input[type="checkbox"]', rows).prop('checked', this.checked);
    });
  });
</script>
</body>
</html>